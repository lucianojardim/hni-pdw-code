@{
    ViewBag.Title = "Companies";
	ViewBag.CurrentPage = "Users";
	ViewBag.CurrentSubPage = "Companies";
	Layout = "~/Views/Shared/HeaderLayout.cshtml";
}

<h2>Company List</h2>

<a href="@Url.Action( "Add", "Company" )" id="addNewCompany">Add New</a><br />
Company Type: @Html.DropDownList( "CompanyType", ProductDataWarehouse.Controllers.CompanyController.GetCompanyTypeFilterList() )<br />
Territory: @Html.DropDownList( "TerritoryID", ProductDataWarehouse.Controllers.CompanyController.GetTerritoryDDList( true ) )
<div>
    <table id="companyList">
    <thead></thead>
    <tfoot></tfoot>
    </table>
</div>

<script type="text/javascript">
	$(document).ready(function () {
		$('#CompanyType').change(loadCompanies);
		$('#TerritoryID').change(loadCompanies);

		loadCompanies();
	});

	function deleteCompany(dID) {
		if (confirm('Delete Company?')) {
			$.ajax({
				dataType: 'json',
				type: 'GET',
				url: '/Company/Delete',
				data: { id: dID },
				success: function (data, textStatus, jqXHR) {
					loadCompanies();
				},
				error: function (jqXHR, textStatus, errorThrown) {
					alert('Error deleting this Company:' + errorThrown)
				}
			});
		}
	}

	var oTable = null;
	function loadCompanies() {
		if (oTable != null) {
			oTable.fnDraw();
			return;
		}

		oTable = $('#companyList').dataTable({
			"bServerSide": true,
			"bAutoWidth": false,
			"bFilter": true,
			"bLengthChange": false, // don't show dropdown for #items per page
			"bPaginate": true,
			"bInfo": true,
			"sAjaxSource": '@Url.Action( "FullCompanyList" )',
			"fnServerParams": function (aoData) {
				aoData.push({ "name": "companyType", "value": $('#CompanyType').val() });
				aoData.push({ "name": "territoryId", "value": $('#TerritoryID').val() });
			},
			"iDisplayLength": 100,
			"fnServerData": function (sSource, aoData, fnCallback) {
				$.ajax({
					dataType: 'json',
					type: "POST",
					url: sSource,
					data: aoData,
					success: function (data, textStatus, jqXHR) {
						fnCallback(data, textStatus, jqXHR);
					},
					error: function (jqXHR, textStatus, errorThrown) { alert('Error getting list of Companies:' + errorThrown) }
				})
			},
			"bProcessing": false, // don't want to use the default progress indicator at this time
			"aaSorting": [[0, "asc"]],
			"aoColumnDefs": [
                    { "sName": "Name", "sTitle": "Name", "aTargets": [0], "mDataProp": "Name", "sWidth": "31%",
                    	"fnRender": function (oObj) {
                    		var s;
                    		s = '<a href=\"@Url.Action( "Edit", "Company" )/' + oObj.aData["CompanyID"] + '">' + oObj.aData["Name"] + '</a>';
                    		return s;
                    	} 
                    },
                    { "sName": "MasterID", "sTitle": "Master Consolidated Number", "aTargets": [1], "mDataProp": "MasterID", "sWidth": "21%" },
                    { "sName": "BaseNumber", "sTitle": "Base Number", "aTargets": [2], "mDataProp": "BaseNumber", "sWidth": "20%" },
                    { "sName": "CompanyType", "sTitle": "Company Type", "aTargets": [3], "mDataProp": "CompanyType", "sWidth": "10%" },
                    { "sName": "UserCount", "sTitle": "# of Users", "aTargets": [4], "mDataProp": "UserCount", "sWidth": "10%", "sType": "numeric" },
                    { "sName": "EditButtons",
                    	"aTargets": [5],
                    	"bSearchable": false,
                    	"bSortable": false,
                    	"mDataProp": "EditButtons", "sWidth": "8%",
                    	"fnRender": function (oObj) {
                    		var s = '';
                    		if (oObj.aData["CanDelete"]) {
                    			s += '<a href=\"#\" onclick="deleteCompany(' + oObj.aData["CompanyID"] + ');">Delete</a>';
                    		}
                    		return s;
                    	}
                    }
                ]
		});
	}

</script>