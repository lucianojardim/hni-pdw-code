@model PDWModels.Companies.MyCompanyInfo
@{
	ViewBag.Title = "MyCompany";
	Layout = "~/Views/Shared/NewLayout.cshtml";
	ViewBag.HeaderArea = "Users";
}
<div class="container">
	<div class="main_inner1">
		<div class="territory-companyProfile">
			<!--left Column -->
			<div class="main_inner2_btm_2Col_Col marginTop30">
				<h2>
					@Model.CompanyName</h2>
				<div class="addrssColmn">
					@Model.Address1<br>
					@if( (Model.Address2 ?? "").Any() )
	 {
		 <text>
					@Model.Address2<br>
					</text>
					}
					@Model.City @Model.State @Model.Zip
				</div>
				<div class="phneFaxWebLblColmn marginTop30">
					Phone<br>
					Fax<br>
					Website
				</div>
				<div class="phneFaxWebInfoColmn marginTop30">
					@Model.PhoneNumber<br>
					@Model.FaxNumber<br>
					<a href="@Model.WebSite">@Model.WebSite</a>
				</div>
				@if( Model.IsTripIncentive )
	{
				<img src="/NewContent/images/incentiveFPO.jpg" alt="" width="455" height="207" class="incentiveImg" />
	}
	@if( PDWInfrastructure.PaoliWebUser.CurrentUser.CanViewMyTerritory )
 {
	 <div class="clear"></div>
	 <span class="btn7" id="editContactBtn">EDIT</span>
 }
			</div>
			<!--//END left Column -->
			<!--right Column -->
			<div class="main_inner2_btm_2Col_Col">
			<a href="#changeCompanyImage" id="changeCompanyImageLink">
				<img src="@(Model.ImageFileName == null ? "/NewContent/images/company-logo-placeholder.png" : ( "/images/" + Model.ImageFileName ))" alt="" style="max-width:450px;max-height:175px;" />
			</a>
			</div>
			<div class="clear"></div>
			<!--//END right Column -->
			<hr>
			<!-- registered user tablature data --->
			<!--<span class="flt_Rt"><img src="img/addPlusSig.jpg" width="15" height="15" />New User</span>-->
			<h4>Registered Users</h4>
			<table class="userTable" id="userList">
			</table>
			<!-- //END registered user tablature data --->
			<div class="clear">
			</div>
		</div>
	</div>
</div>

<div style="display:none;">
	<div id="changeCompanyImage">
    @using( Html.BeginForm( "MyCompanyImage", "User", FormMethod.Post, new { id = "theForm", name = "theForm", enctype = "multipart/form-data" } ) )
	{
		@Html.AntiForgeryToken()
		@Html.HiddenFor( m => m.CompanyID )
		<div class="main_inner2_btm"> 
			<div class="main_inner2_btm_mid_myacct">   
				<h4 class="bold">Update Company Image</h4> 
				<ul>
					<li>
						<div class="colmn3-1">Change Company Image</div>
						<div class="colmn3filebrowser"><input id="CompanyImage" name="CompanyImage" accept=".jpg,.png,.gif,.bmp" type="file"/></div>
					</li>              
				</ul>
				<div class="clear"></div>
				<div class="colmn1">Maximum dimensions are 450x175 and file must be less than 500Kb.</div>
			</div>
			<div class="clear"></div>
			<span class="btn7 cancelCIBtn">CANCEL</span> <span class="btn8 submitCIBtn">SAVE</span> 
		</div>
	}
	</div>

	<a href="#deactivateRequest" id="mainDeactivateBtn"></a>
	<div id="deactivateRequest">
		<div class="main_inner9_btm"> 
			<div class="main_inner9_btm_top">
				<div class="main_inner8_rt_msg">
					<h2 class="bold">Request Deactivation</h2>
					<h5>Please provide a reason for My.Paoli Admin to deactivate.</h5>
					<textarea class="msg1" cols="20" id="Reason" name="Reason" rows="2"></textarea>
					<input type="hidden" id="DUserID" value="" />
				</div>
				<i class="clear_0"></i>
			</div>
			<div class="clear"></div>
			<span class="btn7 cancelDDBtn">CANCEL</span> <span class="btn8 submitDDBtn">SAVE</span> 
		</div>
	</div>

	<a href="#editDealerContactInfo" id="mainEditContactBtn"></a>
	<div id="editDealerContactInfo">
	<div class="main_inner2_btm">
    @using( Html.BeginForm( "DealershipContact", "Company", FormMethod.Post, new { id = "theContactForm", name = "theContactForm", enctype = "multipart/form-data" } ) )
	{
		@Html.AntiForgeryToken()
		@Html.HiddenFor( m => m.CompanyID )
		<div class="main_inner2_btm_mid_myacct">
    		<h4 class="bold">Edit Dealership Contact Information</h4>
			<ul>
        		<li>
            		<div class="colmn1">Name@(Html.ValidationMessageFor( m => m.CompanyName ))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.CompanyName )</div>
				</li>
        		<li>
            		<div class="colmn1">Address 1@(Html.ValidationMessageFor(m => m.Address1))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.Address1 )</div>
				</li>
        		<li>
            		<div class="colmn1">Address 2@(Html.ValidationMessageFor(m => m.Address2))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.Address2 )</div>
				</li>
        		<li>
            		<div class="colmn1">City@(Html.ValidationMessageFor(m => m.City))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.City )</div>
				</li>
				<li>
            		<div class="colmn1">State@(Html.ValidationMessageFor(m => m.State))</div>
					<div class="colmn3single"><div class="styled-select">@Html.DropDownListFor( m => m.State, ProductDataWarehouse.Controllers.UserController.GetStateDDList() )</div></div>
				</li>
				<li>
            		<div class="colmn1">Zip@(Html.ValidationMessageFor(m => m.Zip))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.Zip )</div>
				</li>
				<li>
            		<div class="colmn1">Phone@(Html.ValidationMessageFor( m => m.PhoneNumber ))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.PhoneNumber )</div>
				</li>
				<li>
            		<div class="colmn1">Fax@(Html.ValidationMessageFor( m => m.FaxNumber ))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.FaxNumber )</div>
				</li>                       
				<li>
            		<div class="colmn1">Contact Email@(Html.ValidationMessageFor( m => m.ContactEmail ))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.ContactEmail )</div>
				</li>
				<li>
            		<div class="colmn1">Web Site@(Html.ValidationMessageFor( m => m.WebSite ))</div>
					<div class="colmn3single">@Html.TextBoxFor( m => m.WebSite )</div>
				</li>
			</ul>
			<div class="clear"></div>
			<span class="btn7 cancelContactBtn">CANCEL</span> <span class="btn8 submitContactBtn">SAVE</span> 
		</div>	
	}
	</div>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function () {
		loadUsers();

		$('#changeCompanyImageLink').fancybox({
			'autoDimensions': false,
			'width': 972,
			'height': 220,
			'padding': 20,
			'margin': 0,
			'scrolling': 'auto',
			'titleShow': false
		});

		$('.submitCIBtn').click(function (e) {
			$('#theForm').submit();
		});

		$('.cancelCIBtn').on('click', function() {
			$.fancybox.close();
		});

		$('#mainDeactivateBtn').fancybox({
			'autoDimensions': false,
			'width': 972,
			'height': 260,
			'padding': 20,
			'margin': 0,
			'scrolling': 'auto',
			'titleShow': false
		});

		$('.submitDDBtn').click(function (e) {
			if( $('#Reason').val() != null && $('#Reason').val() != '' ) {
				makeAjaxCall('/User/RequestDeactiviation',
					{ userId: $('#DUserID').val(), reason: $('#Reason').val() },
					function(data, textStatus, jqXHR) {
						alert('Thank you for your request.  We\'ll process it shortly.');
						$.fancybox.close();
					},
    				function (jqXHR, textStatus, errorThrown) {    			
    				}
    			);
			}
		});

		$('.cancelDDBtn').on('click', function() {
			$.fancybox.close();
		});

		$('#editContactBtn').on('click', function() {
			$('#mainEditContactBtn').trigger('click');
		});

		$('#mainEditContactBtn').fancybox({
			'autoDimensions': false,
			'width': 1000,
			'height': 700,
			'padding': 20,
			'margin': 0,
			'scrolling': 'auto',
			'titleShow': false
		});

		$('.submitContactBtn').click(function (e) {
			$('#theContactForm').submit();
		});

		$('.cancelContactBtn').on('click', function() {
			$.fancybox.close();
		});

		@if( ViewBag.ImageTooBig ?? false )
  {
		<text>
		alert('The image provided was too large.  Please use an image less than 500Kb.');
		</text>
  }
	});

	var uTable = null;
	function loadUsers() {
		if (uTable != null) {
			uTable.fnDraw();
			return;
		}

		uTable = $('#userList').dataTable({
			"bServerSide": true,
			"bAutoWidth": false,
			"bFilter": false,
			"bLengthChange": false, // don't show dropdown for #items per page
			"bPaginate": true,
			"bInfo": true,
			"sAjaxSource": '@Url.Action( "MyCompanyUserList", "User" )',
			"fnServerParams": function (aoData) {
				aoData.push({ "name": "companyId", "value": @Model.CompanyID });
			},
			"iDisplayLength": 100,
			"fnServerData": function (sSource, aoData, fnCallback) {
				makeAjaxCall(sSource,
					aoData,
					function (data, textStatus, jqXHR) {
						fnCallback(data, textStatus, jqXHR);

						$('.deactivateBtn').on('click', function() {
							$('#DUserID').val($(this).data('id'));

							$('#mainDeactivateBtn').trigger('click');
						});
					},
					function (jqXHR, textStatus, errorThrown) { alert('Error getting list of Users:' + errorThrown) }
				);
			},
			"bProcessing": false, // don't want to use the default progress indicator at this time
			"aaSorting": [[1, "asc"]],
			"asStripeClasses": [],
			"aoColumnDefs": [
                    { "sName": "FirstName", "sTitle": "First Name<span></span>", "sClass": "hasSpan", "aTargets": [0], "mDataProp": "FirstName", "sWidth": "25%" },
                    { "sName": "LastName", "sTitle": "Last Name<span></span>", "sClass": "hasSpan", "aTargets": [1], "mDataProp": "LastName", "sWidth": "25%" },
                    { "sName": "Title", "sTitle": "Title<span></span>", "sClass": "hasSpan", "aTargets": [2], "mDataProp": "Title", "sWidth": "25%" },
                    { "sName": "Role", "sTitle": "Role<span></span>", "sClass": "hasSpan", "aTargets": [3], "mDataProp": "Role", "sWidth": "25%", "bSortable": false }
					@if( PDWInfrastructure.PaoliWebUser.CurrentUser.CanViewMyTerritory )
	 {
					<text>
					,{ "sName": "EditButtons", "sTitle": "Deactivate", "sClass": "hasSpan", "aTargets": [4], "mDataProp": "EditButtons", "bSortable": false, "sWidth": "5%",
						"fnRender": function(oObj) {
							return '<span class="btn13 deactivateBtn" data-id="' + oObj.aData["UserID"] + '" title="Request Deactivation">X</span>';
						}
					}					</text>
					}
                ]
		});
	}

</script>